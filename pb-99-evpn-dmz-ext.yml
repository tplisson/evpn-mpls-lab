---
  - name: Create Directories
    hosts: localhost
    gather_facts: no

    tasks:

    - name: Create directories      
      vars:
        test_dir: "testcase/1.5"
        detailed_dir: "testcase/1.5/detailed"
      file: 
        path: "{{playbook_dir}}/{{item}}" 
        state: directory
      with_items:
        - "{{test_dir}}"
        - "{{detailed_dir}}"

  - name: "{{testcase}}"
    hosts: DC1
    roles:
     - Juniper.junos
    connection: local
    gather_facts: no
    vars:
      testcase: "Test Case 1-5: EVPN DMZ External Steady State"
      test_dir: "testcase/1.5"
      detailed_dir: "testcase/1.5/detailed"
      credentials:
        host: "{{ inventory_hostname }}"
        user: "{{ ansible_ssh_user }}"
        passwd: "{{ ansible_ssh_pass }}"
  
    tasks:

    - name: Checking NETCONF connectivity
      wait_for: 
        host: "{{ inventory_hostname }}"
        port: "{{ ansible_port }}"
        timeout: 2
      register: netconf_result

    - name: Gathering regular output for {{testcase}}
      when: netconf_result|success
      juniper_junos_command:
        command:
          - 'show evpn instance'
          - 'show evpn database '
          - 'show evpn l3-context'
          - 'show evpn mac-table '
          - 'show evpn mac-ip-table'
          - 'show evpn arp-table'
          - 'show evpn nd-table'
          - 'show bgp summary instance vrf1001'
          - 'show route table vlan1001'
          - 'show route table vrf1001'
          - 'show route forwarding-table table vrf1001'
          - 'show interfaces ae10.1001 detail | match EVPN'
        dest_dir: "{{playbook_dir}}/{{test_dir}}/"
        return_output: false

    - name: Gathering regular output for loopback routes
      when: netconf_result|success
      juniper_junos_command:
        command:
          - "show route 100.1/16"
        dest: "{{playbook_dir}}/{{test_dir}}/{{ inventory_hostname }}_show_route_100.1.text"
        return_output: false

    - name: Gathering detailed output for {{testcase}}
      when: netconf_result|success
      juniper_junos_command:
        command:
          - 'show evpn database extensive'
          - 'show evpn mac-table extensive'
          - 'show evpn mac-ip-table extensive'
          - 'show route summary'
          - 'show route'
          - 'show route table inet.3 extensive'
        dest_dir: "{{playbook_dir}}/{{detailed_dir}}/"
        return_output: false

    - name: Gathering detailed output for loopback routes
      when: netconf_result|success
      juniper_junos_command:
        command:
          - "show route 100.1/16 extensive"
        dest: "{{playbook_dir}}/{{detailed_dir}}/{{ inventory_hostname }}_show_route_100.1_extensive.text"
        return_output: false
