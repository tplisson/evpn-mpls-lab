---
  - hosts: localhost:LEAF
    gather_facts: no
    tasks:
    - set_fact: 
        testcase: 7-1-MULTICAST-IGMP
        test_dir: "testcase/7-1-MULTICAST-IGMP/1"
        cacheable: yes
  
  - hosts: localhost
    gather_facts: no
    tasks:
    - file: 
        path: "{{playbook_dir}}/{{test_dir}}" 
        state: directory
  
  - name: 7-1-MULTICAST-IGMP
    hosts: LEAF
    roles:
      - Juniper.junos
    connection: local
    gather_facts: no
    tasks:

    - name: DISABLE IGMP snooping for EVI 30 on all LEAF routers.
      juniper_junos_config:
        load: 'merge'
        lines:
          - 'deactivate routing-instances vlan30 protocols igmp-snooping'
        format: 'set'
        #retrieve: 'candidate'
        comment: "Deploying {{testcase|upper}} configuration"
        dest_dir: "{{playbook_dir}}/{{test_dir}}/"
      register: config_results
    
    - name: Print the config changes.
      debug:
        var: config_results.diff_lines
      when: config_results.diff_lines is defined

    - name: Pre-Checks
      juniper_junos_command:
        command:
          - "set cli timestamp"
          - "show configuration routing-instances vlan30 protocols igmp-snooping"
          - "show interfaces ae10 statistics"
          - 'show interfaces xe-0/0/0:1 statistics'
        dest_dir: "{{playbook_dir}}/{{test_dir}}/"
        #return_output: false
      register: pre_checks
    - name: Print the output
      debug:
        var: pre_checks
    
    #- name: Sleep for 10 seconds and continue with play
    #  wait_for:
    #    timeout: 10

    - name: ENABLE IGMP snooping for EVI 30 on all LEAF routers.
      juniper_junos_config:
        load: 'merge'
        lines:
          - 'activate routing-instances vlan30 protocols igmp-snooping'
        format: 'set'
        #retrieve: 'candidate'
        comment: "Deploying {{testcase|upper}} configuration"
        dest_dir: "{{playbook_dir}}/{{test_dir}}/"
      register: config_results
    - name: Print the config changes.
      debug:
        var: config_results.diff_lines
      when: config_results.diff_lines is defined

    - name: Sleep for 10 seconds and continue with play
      wait_for:
        timeout: 10

    - name: Post-Checks
      juniper_junos_command:
        command:
          - "set cli timestamp"
          - "show configuration routing-instances vlan30 protocols igmp-snooping"
          - "show evpn igmp-snooping proxy"
          - "show multicast snooping route instance vlan30"
          - "show interfaces ae10 statistics"
          - 'show interfaces ae11 statistics'
        dest_dir: "{{playbook_dir}}/{{test_dir}}/"
        #return_output: false
      register: post_checks
    - name: Print the output
      debug:
        var: post_checks